# RAG Service SQL Parameter Binding Fix

## Problem

The original `_hybrid_search` method in `app/services/rag_service.py` used SQLAlchemy's named parameter syntax (`:param_name`), which is not compatible with asyncpg. This caused syntax errors when executing queries.

## Original Issue

```python
query_sql = text("""
    ...
    1 - (c.embedding <=> :embedding::vector) as semantic_score
    ...
    WHERE c.content_tsv @@ websearch_to_tsquery('english', :query)
    ...
""")
params = {
    "embedding": embedding_str,
    "query": query,
    ...
}
result = await self.session.execute(query_sql, params)
```

**Error**: `syntax error at or near ':'`

## Solution

The fix uses two approaches for different types of parameters:

### 1. Safe Direct Interpolation (for non-user input)
- **Embedding vector**: Interpolated directly using f-string (safe - generated internally by embedding service)
- **Chapter ID**: Interpolated directly using f-string (safe - UUID from our system, not user input)

### 2. Positional Parameters (for user input and numeric values)
- **Query string**: Uses `$1` positional parameter
- **Weights and limit**: Uses `$2`, `$3`, `$4` positional parameters

## Fixed Code

```python
# Convert embedding to PostgreSQL vector format
embedding_str = "[" + ",".join(map(str, query_embedding)) + "]"

# Build chapter filter
if chapter_id:
    chapter_filter_sql = f"AND c.chapter_id = '{str(chapter_id)}'"
else:
    chapter_filter_sql = ""

# Build SQL with mixed interpolation and positional params
query_sql = text(f"""
    WITH semantic_scores AS (
        SELECT
            ...
            1 - (c.embedding <=> '{embedding_str}'::vector) as semantic_score
        FROM chunks c
        WHERE true {chapter_filter_sql}
    ),
    keyword_scores AS (
        SELECT
            c.id,
            ts_rank(c.content_tsv, websearch_to_tsquery('english', $1)) as keyword_score
        FROM chunks c
        WHERE c.content_tsv @@ websearch_to_tsquery('english', $1)
            {chapter_filter_sql}
    ),
    combined AS (
        SELECT
            ...
            ($2 * s.semantic_score + $3 * COALESCE(k.keyword_score, 0.0)) as combined_score
        ...
    )
    ...
    LIMIT $4
""")

# Execute with positional parameters
result = await self.session.execute(
    query_sql,
    [query, self.semantic_weight, self.keyword_weight, limit]
)
```

## Security Considerations

### Safe to Interpolate
- **Embedding vector**: Generated by OpenAI API, contains only floats
- **Chapter ID**: UUID type from our database, validated by PostgreSQL

### Requires Parameter Binding
- **User query string**: Direct user input, must use positional parameters to prevent SQL injection
- **Numeric parameters**: While not user input, using positional params is cleaner

## Testing

Created `tests/test_rag_sql_syntax.py` to verify:
1. SQL compiles without syntax errors
2. Works with chapter filter
3. Works without chapter filter

All tests pass âœ“

## Benefits

1. **Compatible with asyncpg**: Uses positional parameters that asyncpg expects
2. **Secure**: User input properly parameterized
3. **Performant**: Direct interpolation for safe internal values avoids unnecessary parameter overhead
4. **Maintainable**: Clear comments explain which values are safe to interpolate

## Migration Notes

No database migrations required - this is purely a code fix for query execution.
